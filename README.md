# GKE Terraform Cleaner (`gke-tf-cleaner`)

`gke-tf-cleaner` is a command-line tool written in Go designed to clean up and normalize Terraform HCL configuration files for Google Kubernetes Engine (GKE) `google_container_cluster` resources. It is particularly useful for refining configurations generated by `terraform import` or `terraform plan -generate-config-out=...`.

## The Problem

Terraform's import process is a valuable feature, but for complex resources like GKE clusters, the automatically generated configuration can sometimes include:
- Read-only attributes that cause errors on subsequent applies.
- Conflicting attribute pairs where only one should be specified for management.
- Deprecated or less preferred fields when newer, more flexible options exist.
- Attributes that are suitable for initial creation but problematic for ongoing management of existing clusters (e.g., `initial_node_count` vs. actual `node_count` or autoscaling).

Manually cleaning these up can be time-consuming and error-prone.

## Purpose of `gke-tf-cleaner`

This tool automates the application of a predefined set of cleaning rules to your GKE Terraform configuration. By addressing common post-import issues, it helps:
- Reduce the likelihood of errors during `terraform apply`.
- Align configurations with recommended practices for GKE management.
- Save time and effort in manually tidying up generated HCL.

## Key Features & Rules Applied

`gke-tf-cleaner` applies the following rules to your `google_container_cluster` resources:

*   **Cluster IP CIDR Cleanup:**
    *   **What:** Removes the top-level `cluster_ipv4_cidr` attribute if `ip_allocation_policy.cluster_ipv4_cidr_block` also exists.
    *   **Why:** `ip_allocation_policy` is the preferred way to define IP allocation. Having both can be redundant or conflicting.
*   **Master IP Configuration Cleanup (Private Clusters):**
    *   **What:** Removes `private_cluster_config.private_endpoint_subnetwork` if `master_ipv4_cidr_block` and `private_cluster_config` exist.
    *   **Why:** For private clusters with `master_ipv4_cidr_block` defined, `private_endpoint_subnetwork` is often redundant and can cause configuration errors.
*   **Services IP CIDR Cleanup:**
    *   **What:** Removes `ip_allocation_policy.services_ipv4_cidr_block` if `ip_allocation_policy.cluster_secondary_range_name` (for services) also exists.
    *   **Why:** Using a named secondary range is preferred for VPC-native clusters; defining the CIDR directly can be conflicting or redundant.
*   **Binary Authorization Configuration:**
    *   **What:** Removes the `binary_authorization.enabled` attribute if `binary_authorization.evaluation_mode` is also present.
    *   **Why:** `evaluation_mode` is generally sufficient to control Binary Authorization; `enabled` can be redundant.
*   **Logging Service Cleanup:**
    *   **What:** Removes the `logging_service` attribute if `cluster_telemetry.type` is set to `"ENABLED"`.
    *   **Why:** When Cloud Operations for GKE is enabled (`cluster_telemetry.type = "ENABLED"`), it manages logging, making `logging_service` redundant.
*   **Monitoring Service Cleanup:**
    *   **What:** Removes the `monitoring_service` attribute if the `monitoring_config` block exists.
    *   **Why:** The `monitoring_config` block is the modern and preferred way to configure monitoring (e.g., for managed Prometheus); `monitoring_service` is legacy.
*   **Node Version Cleanup (Cluster-Level):**
    *   **What:** Removes the cluster-level `node_version` attribute if `min_master_version` (control plane version) also exists.
    *   **Why:** Encourages node version management at the node pool level or reliance on GKE defaults relative to the master version, preventing conflicts.
*   **Initial Node Count Cleanup (Node Pools):**
    *   **What:** Removes `initial_node_count` from all `node_pool` blocks.
    *   **Why:** For imported or existing node pools, `initial_node_count` can conflict with `node_count` or autoscaling configurations. Node pool size should be managed by `node_count` or an autoscaler.
*   **Autopilot Configuration Cleanup:**
    *   **What:** If `enable_autopilot = true`, removes numerous attributes and blocks incompatible with Autopilot (e.g., `node_pool` blocks, `cluster_ipv4_cidr`, certain `addons_config` settings, `cluster_autoscaling.enabled`, etc.). If `enable_autopilot` is explicitly `false` or has an invalid (non-boolean) value, the `enable_autopilot` attribute itself is removed to avoid errors and default to standard cluster behavior.
    *   **Why:** Autopilot manages many cluster aspects automatically. Attributes for manual configuration in standard clusters become invalid or are ignored in Autopilot and can cause errors if present in the Terraform configuration. Removing `enable_autopilot` if set to `false` or an invalid value ensures the configuration defaults to a standard cluster, preventing unexpected Autopilot behavior or errors.

## Prerequisites

- Go (version 1.22.2 or later recommended)

## Building the Tool

To build the `gke-tf-cleaner` tool, navigate to the root directory of the project and run:

```bash
go build -o gke-tf-cleaner .
```
This will create an executable file named `gke-tf-cleaner` in the current directory.

## Usage

Run the compiled executable with the `--file` flag specifying the path to the Terraform HCL file you want to modify:

```bash
./gke-tf-cleaner --file path/to/your/gke_cluster.tf
```

**Important:**
*   The tool modifies the specified file **in-place**.
*   It is strongly recommended to use this tool on files under version control (Git) or to create a backup before running the cleaner.

### Example Scenario

Suppose your imported `gke_cluster.tf` contains the following:

```terraform
resource "google_container_cluster" "my_imported_cluster" {
  name                  = "my-gke-cluster"
  location              = "us-central1"
  logging_service       = "logging.googleapis.com/kubernetes" # Will be removed if telemetry is ENABLED
  monitoring_service    = "monitoring.googleapis.com/kubernetes" # Will be removed if monitoring_config exists
  node_version          = "1.25.0-gke.100"                     # Will be removed if min_master_version exists
  min_master_version    = "1.25.0"
  cluster_ipv4_cidr     = "10.0.0.0/14"                        # Will be removed if ip_allocation_policy.cluster_ipv4_cidr_block exists

  ip_allocation_policy {
    cluster_ipv4_cidr_block      = "10.0.0.0/14"
    services_ipv4_cidr_block   = "10.1.0.0/20" # Will be removed if cluster_secondary_range_name for services exists
    cluster_secondary_range_name = "services-range"
  }

  cluster_telemetry {
    type = "ENABLED"
  }

  monitoring_config {
    enable_components = ["SYSTEM_COMPONENTS"]
  }

  binary_authorization {
    enabled = true # Will be removed as evaluation_mode exists
    evaluation_mode = "PROJECT_SINGLETON_POLICY_ENFORCE"
  }

  # Example of a node_pool that would be cleaned by ApplyInitialNodeCountRule
  node_pool {
    name                 = "default-pool"
    initial_node_count   = 1 # This will be removed
    node_count           = 1 
    # ... other node_pool configurations
  }
  
  # If enable_autopilot were true, many of the above and the node_pool block would be removed.
  # enable_autopilot = true 
}
```

After running `./gke-tf-cleaner --file gke_cluster.tf`, the tool would apply the relevant rules, removing or adjusting attributes like `logging_service`, `monitoring_service`, `node_version`, `cluster_ipv4_cidr`, `services_ipv4_cidr_block` (within `ip_allocation_policy`), `binary_authorization.enabled`, and `initial_node_count` from the node pool.

## Logging

The tool uses `go.uber.org/zap` for structured logging. Logs are output to standard error and provide information about the rules being applied and modifications made.

## Disclaimer

This is a utility tool to aid in cleaning up Terraform configurations. While it aims to apply sensible defaults, always review the changes made by the tool before applying them to your infrastructure, especially in production environments. Ensure your Terraform files are under version control.
